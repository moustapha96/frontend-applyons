import { AdminBreadcrumb } from "@/components";
import { useTranslation } from "react-i18next";
import { useForm, Controller } from "react-hook-form";
import { yupResolver } from "@hookform/resolvers/yup";
import * as yup from "yup";
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { Loader } from 'lucide-react';
import { sendSimpleMail } from "@/services/mailerService";
import { toast } from "sonner";
import CreatableSelect from 'react-select/creatable';
import { Editor } from '@tinymce/tinymce-react';
import ReactQuill from "react-quill";
import 'react-quill/dist/quill.snow.css';


const schema = yup.object({
    recipients: yup.array().of(
        yup.object().shape({
            value: yup.string().email("adminMailer.emailInvalid"),
            label: yup.string()
        })
    ).min(1, "adminMailer.emailRequired").required("adminMailer.emailRequired"),
    sujet: yup.string().required("adminMailer.subjectRequired"),
    message: yup.string().required("adminMailer.messageRequired"),
}).required();

const AdminMailer = () => {
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [editorContent, setEditorContent] = useState('');

    const { t } = useTranslation();

    const { control, handleSubmit, reset, formState: { errors, isSubmitting } } = useForm({
        resolver: yupResolver(schema),
        defaultValues: {
            recipients: [],
            sujet: '',
            message: '',
        }
    });

    const onSubmit2 = async (data) => {
        setLoading(true);
        setError(null);
        const emailAddresses = data.recipients.map(recipient => recipient.value);
        //console.log(emailAddresses);
        const body = { ...data, emails: emailAddresses, message: data.message }
        //console.log(body)
        try {
            const response = await sendSimpleMail(body);
            toast.success(response);
            reset();
            setEditorContent('');
        } catch (err) {
            setError(err.message);
            toast.error(err.message);
        } finally {
            setLoading(false);
        }
    };

    const onSubmit = async (data) => {
        setLoading(true);
        setError(null);
        const emailAddresses = data.recipients.map(recipient => recipient.value);
        //console.log(emailAddresses);
        const body = { ...data, emails: emailAddresses }
        //console.log(body)
        try {
            const response = await sendSimpleMail(body);
            toast.success(response);
            reset();
        } catch (err) {
            setError(err.message);
            toast.error(err.message);
        } finally {
            setLoading(false);
        }
    };

    const customStyles = {
        control: (provided, state) => ({
            ...provided,
            borderColor: state.isFocused ? '#4f46e5' : '#e5e7eb',
            boxShadow: state.isFocused ? '0 0 0 1px #4f46e5' : 'none',
            '&:hover': {
                borderColor: '#4f46e5',
            },
        }),
        multiValue: (provided) => ({
            ...provided,
            backgroundColor: '#e0e7ff',
        }),
        multiValueLabel: (provided) => ({
            ...provided,
            color: '#4338ca',
        }),
        multiValueRemove: (provided) => ({
            ...provided,
            color: '#4338ca',
            ':hover': {
                backgroundColor: '#818cf8',
                color: 'white',
            },
        }),
    };

    const validateEmail = (email) => {
        return yup.string().email().isValidSync(email);
    };

    const toolbarOptions = [
        ['bold', 'italic', 'underline', 'strike'],        // toggled buttons
        ['blockquote', 'code-block'],
        ['link', 'image', 'video', 'formula'],

        [{ 'header': 1 }, { 'header': 2 }],               // custom button values
        [{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'list': 'check' }],
        [{ 'script': 'sub' }, { 'script': 'super' }],      // superscript/subscript
        [{ 'indent': '-1' }, { 'indent': '+1' }],          // outdent/indent
        [{ 'direction': 'rtl' }],                         // text direction

        [{ 'size': ['small', false, 'large', 'huge'] }],  // custom dropdown
        [{ 'header': [1, 2, 3, 4, 5, 6, false] }],

        [{ 'color': [] }, { 'background': [] }],          // dropdown with defaults from theme
        [{ 'font': [] }],
        [{ 'align': [] }],

        ['clean']                                         // remove formatting button
    ];
    const module = {
        toolbar: toolbarOptions,
    }

    return (
        <>
            <AdminBreadcrumb title={t("adminMailer.title")} />
            <section>
                <div className="container">
                    <div className="my-6 space-y-6">
                        <div className="grid grid-cols-1">
                            <div className="bg-white shadow-lg rounded-lg overflow-hidden">
                                <div className="flex items-center justify-between border-b border-gray-200 px-6 py-4">
                                    <h4 className="text-xl font-semibold text-gray-800 uppercase">{t("adminMailer.title")}</h4>
                                </div>

                                <div className="max-w-3xl mx-auto px-4 py-8 bg-white shadow-md rounded-md">
                                    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
                                        <div>
                                            <label htmlFor="recipients" className="block text-sm font-medium text-gray-700">{t("adminMailer.recipients")}</label>
                                            <Controller
                                                name="recipients"
                                                control={control}
                                                render={({ field }) => (
                                                    <CreatableSelect
                                                        {...field}
                                                        isMulti
                                                        options={[]}
                                                        placeholder={t("adminMailer.enterEmails")}
                                                        noOptionsMessage={() => t("adminMailer.typeToAddEmail")}
                                                        className="mt-1"
                                                        styles={customStyles}
                                                        formatCreateLabel={(inputValue) => `${t("adminMailer.addEmail")} "${inputValue}"`}
                                                        isValidNewOption={(inputValue) => validateEmail(inputValue)}
                                                    />
                                                )}
                                            />
                                            {errors.recipients && <p className="mt-2 text-sm text-red-500">{t(errors.recipients.message)}</p>}
                                        </div>

                                        <div>
                                            <label htmlFor="sujet" className="block text-sm font-medium text-gray-700">{t("adminMailer.subject")}</label>
                                            <Controller
                                                name="sujet"
                                                control={control}
                                                render={({ field }) => (
                                                    <input
                                                        {...field}
                                                        type="text"
                                                        id="sujet"
                                                        className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                                    />
                                                )}
                                            />
                                            {errors.sujet && <p className="mt-2 text-sm text-red-500">{t(errors.sujet.message)}</p>}
                                        </div>



                                        {/* <div>
                                            <label htmlFor="message" className="block text-sm font-medium text-gray-700">{t("adminMailer.message")}</label>
                                            <Controller
                                                name="message"
                                                control={control}
                                                render={({ field }) => (
                                                    <textarea
                                                        {...field}
                                                        id="message"
                                                        rows={4}
                                                        className="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
                                                    />
                                                )}
                                            />
                                            {errors.message && <p className="mt-2 text-sm text-red-500">{t(errors.message.message)}</p>}
                                        </div> */}

                                        <div>
                                            <Controller
                                                name="message"
                                                control={control}
                                                render={({ field }) => (
                                                    // <Editor
                                                    //     apiKey="3ehzojqcdzzu9yh0owy67re3ssg4j0qb3czadgxmf4gsi6y1"
                                                    //     onEditorChange={(content, editor) => {
                                                    //         field.onChange(content);
                                                    //         setEditorContent(content);
                                                    //     }}
                                                    //     value={editorContent}
                                                    //     init={{
                                                    //         height: 250,
                                                    //         menubar: false,
                                                    //         plugins: [
                                                    //             'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'image', 'link', 'lists', 'media', 'searchreplace', 'table', 'visualblocks', 'wordcount',
                                                    //             'checklist', 'mediaembed', 'casechange', 'export', 'formatpainter', 'pageembed', 'a11ychecker', 'tinymcespellchecker', 'permanentpen', 'powerpaste', 'advtable', 'advcode', 'editimage', 'advtemplate', 'ai', 'mentions', 'tinycomments', 'tableofcontents', 'footnotes', 'mergetags', 'autocorrect', 'typography', 'inlinecss', 'markdown', 'importword', 'exportword', 'exportpdf'
                                                    //         ],
                                                    //         toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
                                                    //         tinycomments_mode: 'embedded',
                                                    //         tinycomments_author: 'Author name',
                                                    //         mergetags_list: [
                                                    //             { value: 'First.Name', title: 'First Name' },
                                                    //             { value: 'Email', title: 'Email' },
                                                    //         ],
                                                    //     }}
                                                    // />
                                                    <ReactQuill
                                                        theme="snow"
                                                        value={editorContent}
                                                        modules={module}
                                                        onEditorChange={(content, editor) => {
                                                            field.onChange(content);
                                                            setEditorContent(content);
                                                        }}

                                                    />
                                                )}
                                            />
                                            {errors.message && <p className="mt-2 text-sm text-red-500">{t(errors.message.message)}</p>}
                                        </div>



                                        {/* <div>

                                            <Editor
                                                apiKey="3ehzojqcdzzu9yh0owy67re3ssg4j0qb3czadgxmf4gsi6y1" // Remplacez par une clÃ© API valide ou laissez vide
                                                init={{
                                                    selector: 'textarea',
                                                    height: 200,
                                                    menubar: false,
                                                    plugins: [
                                                        'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'image', 'link', 'lists', 'media', 'searchreplace', 'table', 'visualblocks', 'wordcount',
                                                        'checklist', 'mediaembed', 'casechange', 'export', 'formatpainter', 'pageembed', 'a11ychecker', 'tinymcespellchecker', 'permanentpen', 'powerpaste', 'advtable', 'advcode', 'editimage', 'advtemplate', 'ai', 'mentions', 'tinycomments', 'tableofcontents', 'footnotes', 'mergetags', 'autocorrect', 'typography', 'inlinecss', 'markdown', 'importword', 'exportword', 'exportpdf'
                                                    ],
                                                    toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link image media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
                                                    tinycomments_mode: 'embedded',
                                                    tinycomments_author: 'Author name',
                                                    mergetags_list: [
                                                        { value: 'First.Name', title: 'First Name' },
                                                        { value: 'Email', title: 'Email' },
                                                    ],
                                                }}
                                            />
                                        </div> */}
                                        <div className="flex justify-end space-x-4">
                                            <button
                                                type="button"
                                                onClick={() => reset()}
                                                disabled={loading}
                                                className="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                                            >
                                                {t("adminMailer.cancel")}
                                            </button>
                                            <button
                                                type="submit"
                                                disabled={loading || isSubmitting}
                                                className="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blueLogo focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
                                            >
                                                <span className="flex items-center">
                                                    {loading || isSubmitting ? <Loader className="mr-2 h-4 w-4 animate-spin" /> : null}
                                                    {t("adminMailer.submit")}
                                                </span>
                                            </button>
                                        </div>
                                    </form>
                                </div>
                                <div>


                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </>
    );
};

export default AdminMailer;

